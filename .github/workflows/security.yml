name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * 1" # Каждый понедельник в 2:00

jobs:
  # Сканирование зависимостей
  dependency-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            vetguide-api/package-lock.json
            vetguide-ui/package-lock.json

      # Сканирование API зависимостей
      - name: Install API dependencies
        working-directory: ./vetguide-api
        run: npm ci

      - name: Run API security audit
        working-directory: ./vetguide-api
        run: npm audit --audit-level=moderate

      # Сканирование UI зависимостей
      - name: Install UI dependencies
        working-directory: ./vetguide-ui
        run: npm ci

      - name: Run UI security audit
        working-directory: ./vetguide-ui
        run: npm audit --audit-level=moderate

  # Сканирование Docker образов
  docker-scan:
    runs-on: ubuntu-latest
    needs: dependency-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Сборка и сканирование API образа
      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: ./vetguide-api
          push: false
          tags: vetguide-api:security-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner on API
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "vetguide-api:security-scan"
          format: "sarif"
          output: "trivy-api-results.sarif"

      # Сборка и сканирование UI образа
      - name: Build UI image
        uses: docker/build-push-action@v5
        with:
          context: ./vetguide-ui
          push: false
          tags: vetguide-ui:security-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner on UI
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "vetguide-ui:security-scan"
          format: "sarif"
          output: "trivy-ui-results.sarif"

      # Загрузка результатов сканирования
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-api-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-ui-results.sarif"

  # Сканирование секретов
  secret-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Полная история для лучшего сканирования

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # Сканирование кода
  code-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            vetguide-api/package-lock.json
            vetguide-ui/package-lock.json

      # Установка зависимостей
      - name: Install API dependencies
        working-directory: ./vetguide-api
        run: npm ci

      - name: Install UI dependencies
        working-directory: ./vetguide-ui
        run: npm ci

      # Сканирование кода с ESLint
      - name: Run ESLint on API
        working-directory: ./vetguide-api
        run: npm run lint || true

      - name: Run ESLint on UI
        working-directory: ./vetguide-ui
        run: npm run lint || true

      # Сканирование с SonarCloud (если настроен)
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

  # Уведомления о проблемах безопасности
  security-notify:
    runs-on: ubuntu-latest
    needs: [dependency-scan, docker-scan, secret-scan, code-scan]
    if: always()

    steps:
      - name: Notify security issues
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: "#security"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            Security scan completed for VetGuide
            - Dependency scan: ${{ needs.dependency-scan.result }}
            - Docker scan: ${{ needs.docker-scan.result }}
            - Secret scan: ${{ needs.secret-scan.result }}
            - Code scan: ${{ needs.code-scan.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true

